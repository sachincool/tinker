name: Send Newsletter on New Blog Post

on:
  push:
    branches: [main]
    paths:
      - 'content/blog/**'
  workflow_dispatch:

jobs:
  notify-subscribers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new blog posts
        id: detect
        run: |
          # Find newly added files in content/blog/ (not modified/renamed)
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'content/blog/*.md' || true)

          if [ -z "$NEW_FILES" ]; then
            echo "No new blog posts found"
            echo "has_new_posts=false" >> "$GITHUB_OUTPUT"
          else
            echo "New blog posts detected:"
            echo "$NEW_FILES"
            echo "has_new_posts=true" >> "$GITHUB_OUTPUT"
            # Write newline-separated file list for the next step
            echo "$NEW_FILES" > /tmp/new_posts.txt
          fi

      - name: Setup Bun
        if: steps.detect.outputs.has_new_posts == 'true'
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.detect.outputs.has_new_posts == 'true'
        run: bun install

      - name: Send newsletter for new posts
        if: steps.detect.outputs.has_new_posts == 'true'
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          SITE_URL: https://harshit.cloud
        run: |
          node << 'SCRIPT'
          const fs = require("fs");
          const matter = require("gray-matter");

          const newPosts = fs.readFileSync("/tmp/new_posts.txt", "utf8")
            .trim()
            .split("\n")
            .filter(Boolean);

          const apiKey = process.env.BUTTONDOWN_API_KEY;
          const siteUrl = process.env.SITE_URL;

          if (!apiKey) {
            console.error("BUTTONDOWN_API_KEY is not set");
            process.exit(1);
          }

          async function sendNewsletter(filePath) {
            const raw = fs.readFileSync(filePath, "utf8");
            const { data, content } = matter(raw);

            const slug = filePath
              .replace("content/blog/", "")
              .replace(".md", "");
            const postUrl = `${siteUrl}/blog/${slug}`;
            const title = data.title || slug;
            const excerpt = data.excerpt || content.substring(0, 200) + "...";
            const tags = (data.tags || []).map(t => `\`${t}\``).join(" ");

            const subject = `New Post: ${title}`;
            const body = [
              `# ${title}`,
              "",
              excerpt,
              "",
              tags ? `**Tags:** ${tags}` : "",
              "",
              `**[Read the full post â†’](${postUrl})**`,
              "",
              "---",
              "",
              "*You're receiving this because you subscribed at [harshit.cloud](https://harshit.cloud). Reply to this email if you have thoughts!*",
            ].filter(line => line !== undefined).join("\n");

            console.log(`Sending newsletter for: ${title}`);
            console.log(`  URL: ${postUrl}`);

            const res = await fetch("https://api.buttondown.com/v1/emails", {
              method: "POST",
              headers: {
                "Authorization": `Token ${apiKey}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                subject,
                body,
                status: "draft",  // TODO: change to "about_to_send" after testing
              }),
            });

            if (!res.ok) {
              const err = await res.text();
              console.error(`Failed to send newsletter for "${title}": ${res.status} ${err}`);
              process.exit(1);
            }

            console.log(`Newsletter sent for: ${title}`);
          }

          (async () => {
            for (const post of newPosts) {
              await sendNewsletter(post);
            }
            console.log(`Done! Sent ${newPosts.length} newsletter(s).`);
          })();
          SCRIPT
